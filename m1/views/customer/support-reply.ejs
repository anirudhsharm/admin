<% layout('layouts/admin') %>
<style>
     #custom-search-input {
  background: #e8e6e7 none repeat scroll 0 0;
  margin: 0;
  padding: 10px;
}
   #custom-search-input .search-query {
   background: #fff none repeat scroll 0 0 !important;
   border-radius: 4px;
   height: 33px;
   margin-bottom: 0;
   padding-left: 7px;
   padding-right: 7px;
   }
   #custom-search-input button {
   background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
   border: 0 none;
   border-radius: 3px;
   color: #666666;
   left: auto;
   margin-bottom: 0;
   margin-top: 7px;
   padding: 2px 5px;
   position: absolute;
   right: 0;
   z-index: 9999;
   }
   .search-query:focus + button {
   z-index: 3;   
   }
   .all_conversation button {
   background: #f5f3f3 none repeat scroll 0 0;
   border: 1px solid #dddddd;
   height: 38px;
   text-align: left;
   width: 100%;
   }
   .all_conversation i {
   background: #e9e7e8 none repeat scroll 0 0;
   border-radius: 100px;
   color: #636363;
   font-size: 17px;
   height: 30px;
   line-height: 30px;
   text-align: center;
   width: 30px;
   }
   .all_conversation .caret {
   bottom: 0;
   margin: auto;
   position: absolute;
   right: 15px;
   top: 0;
   }
   .all_conversation .dropdown-menu {
   background: #f5f3f3 none repeat scroll 0 0;
   border-radius: 0;
   margin-top: 0;
   padding: 0;
   width: 100%;
   }
   .all_conversation ul li {
   border-bottom: 1px solid #dddddd;
   line-height: normal;
   width: 100%;
   }
   .all_conversation ul li a:hover {
   background: #dddddd none repeat scroll 0 0;
   color:#333;
   }
   .all_conversation ul li a {
  color: #333;
  line-height: 30px;
  padding: 3px 20px;
}
   .member_list .chat-body {
   margin-left: 47px;
   margin-top: 0;
   }
   .top_nav {
   overflow: visible;
   }
   .member_list .contact_sec {
   margin-top: 3px;
   }
   .member_list li {
   padding: 6px;
   }
   .member_list ul {
   border: 1px solid #dddddd;
   }
   .chat-img img {
   height: 34px;
   width: 34px;
   }
   .member_list li {
   border-bottom: 1px solid #dddddd;
   padding: 6px;
   }
   .member_list li:last-child {
   border-bottom:none;
   }
   .member_list {
   height: 380px;
   overflow-x: hidden;
   overflow-y: auto;
   }
   .sub_menu_ {
  background: #e8e6e7 none repeat scroll 0 0;
  left: 100%;
  max-width: 233px;
  position: absolute;
  width: 100%;
}
.sub_menu_ {
  background: #f5f3f3 none repeat scroll 0 0;
  border: 1px solid rgba(0, 0, 0, 0.15);
  display: none;
  left: 100%;
  margin-left: 0;
  max-width: 233px;
  position: absolute;
  top: 0;
  width: 100%;
}
.all_conversation ul li:hover .sub_menu_ {
  display: block;
}
.new_message_head button {
  background: rgba(0, 0, 0, 0) none repeat scroll 0 0;
  border: medium none;
}
.new_message_head {
  background: #f5f3f3 none repeat scroll 0 0;
  float: left;
  font-size: 13px;
  font-weight: 600;
  padding: 18px 10px;
  width: 100%;
}
.message_section {
  border: 1px solid #dddddd;
}
.chat_area {
  float: left;
  height: 450px;
  overflow-x: hidden;
  overflow-y: auto;
  width: 100%;
}
.chat_area li {
  padding: 14px 14px 0;
}
.chat_area li .chat-img1 img {
  height: 40px;
  width: 40px;
}
.chat_area .chat-body1 {
  margin-right: 450px;
}
.chat-body1 p {
  background: #fbf9fa none repeat scroll 0 0;
  padding: 10px;
}
.chat_area .admin_chat .chat-body1 {
  margin-right: 0;
  margin-left: 450px;
}
.chat_area li:last-child {
  padding-bottom: 10px;
}
.message_write {
  background: #f5f3f3 none repeat scroll 0 0;
  float: left;
  padding: 15px;
  width: 100%;
}

.message_write textarea.form-control {
  height: 70px;
  padding: 10px;
}
.chat_bottom {
  float: left;
  margin-top: 13px;
  width: 100%;
}
.upload_btn {
  color: #777777;
}
.sub_menu_ > li a, .sub_menu_ > li {
  float: left;
  width:100%;
}
.member_list li:hover {
  background: #428bca none repeat scroll 0 0;
  color: #fff;
  cursor:pointer;
}
.chat-body1 p {
  background-color: #cce5ff;
    color: #000;
}
.admin_chat .chat-body1 p {
  background-color: #FFA534;
  color: #fff;
}
.admin_chat .chat-body1 .chat_time {
  float: right;
}
</style>
<div class="row">
    <div class="col-md-12">
      <div class="alert alert-info" role="alert">
        Subject :: <%- data.subject %>
      </div>
        <div class="card data-tables">
            <div class="card-header ">
                <% include ../elements/flash.ejs %>
            </div>
            <div class="card-body table-striped table-no-bordered table-hover dataTable dtr-inline table-full-width">
                <div class="main_section">
                    <div class="container">
                       <div class="chat_container">
                          <div class="chat_area">
                             <ul class="list-unstyled" id = "message-area">
                              <% if (typeof(data.reply) !== 'undefined') {  %>
                                  <% (data.reply).forEach(function(reply, index) {  %>
                                    <li class="left clearfix  <% if (reply.sentBy == 'admin') { %> admin_chat <% }  %> ">
                                      <div class="chat-body1 clearfix">
                                          <p><%- reply.message %></p>
                                          <div class="chat_time"><%- moment(reply.sentAT).format("MMM Do, h:mm a") %></div>
                                      </div>
                                    </li>
                                  <% }); %>
                              <% } %>
                             </ul>
                          </div>
                          <!--chat_area-->
                          <form class="form-horizontal" method="post" role="form" action="" name="supportForm" id="supportForm">
                            <div class="message_write">
                              <textarea class="form-control" placeholder="type a message" id = "message" name = "message"></textarea>
                              <div class="clearfix"></div>
                              <div class="chat_bottom ">
                                  <button type="submit" class="btn btn-success pull-right" id = "submitBtn">Send</button>
                              </div>
                            </div>
                          </form> 
                       </div>
                    </div>
                    <!--message_section-->
                 </div>
                 </div>
                 </div>
            </div>
        </div>
    </div>
</div>

<script>
$('.chat_area').scrollTop($('.chat_area')[0].scrollHeight);
$('#supportForm').on('submit', function (event) {
    event.preventDefault();
    var message = $('#message').val().trim();
    if (!message) return false;
    $.ajax({
      url: '<%= admin_url %>customer/support-reply/<%= data._id %>',
      type: 'POST',
      data: {
        'message' : message
      },
      beforeSend: function() {
        $('#submitBtn').text('sending....').css('cursor', 'none');
      },
      success: function(result) {
        let msg = '<li class="left clearfix admin_chat"> <div class="chat-body1 clearfix"><p>'+message+'</p><div class="chat_time">'+moment(result.sentAT).format("MMM Do, h:mm a")+'</div></div></li>';
        $('#message-area').append(msg);
        $('#message').val('');
        $('.chat_area').scrollTop($('.chat_area')[0].scrollHeight);
        $('#submitBtn').replaceWith('<button type="submit" class="btn btn-success pull-right" id = "submitBtn">Send</button>');
      }
  });
});
</script>